---
phase: 07-foundation-authentication
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - frontend/app.py
  - frontend/pages/home.py
  - frontend/utils/auth.py
  - frontend/utils/session.py
autonomous: true

must_haves:
  truths:
    - "Navigation shows different pages based on authentication state"
    - "Sidebar displays current user info (name, role, session type)"
    - "User can logout via button and return to login screen"
    - "Anonymous user can browse app without logging in"
  artifacts:
    - path: "frontend/app.py"
      provides: "Main entry point with st.navigation"
      min_lines: 50
    - path: "frontend/pages/home.py"
      provides: "Home page for authenticated users"
      min_lines: 20
  key_links:
    - from: "frontend/app.py"
      to: "st.navigation"
      via: "single navigation call"
      pattern: "pg = st.navigation"
    - from: "frontend/app.py"
      to: "frontend/utils/session.py"
      via: "session initialization"
      pattern: "init_session_state"
---

<objective>
Create main app entry point with dynamic navigation, sidebar user info, logout, and anonymous session support.

Purpose: Wire all authentication flows together into cohesive app with proper navigation based on auth state.
Output: app.py (main entry), home.py (authenticated landing), logout handler, sidebar with user info.
</objective>

<execution_context>
@/Users/apple/.claude/get-shit-done/workflows/execute-plan.md
@/Users/apple/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-foundation-authentication/07-RESEARCH.md
@.planning/phases/07-foundation-authentication/07-01-SUMMARY.md
@.planning/phases/07-foundation-authentication/07-02-SUMMARY.md
@.planning/phases/07-foundation-authentication/07-03-SUMMARY.md
@backend/app/api/auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add logout handler and anonymous session support</name>
  <files>
    frontend/utils/auth.py
    frontend/utils/session.py
  </files>
  <action>
Update auth.py and session.py with logout and anonymous session functionality.

1. Add to auth.py - handle_logout() callback:
   - Call logout() from api_client with current access_token
   - Call clear_auth_state() from session.py to reset session
   - Note: Streamlit auto-reruns, navigation will show login page

2. Update session.py - enhance init_session_state():
   - Initialize session_type to "anonymous" if no tokens present
   - Add anonymous session ID tracking (for display in sidebar)

3. Add to session.py - render_user_info():
   - Create sidebar widget showing user info
   - If authenticated: show email, role, session type
   - If anonymous: show "Anonymous Session", session ID hint
   - Include logout button for authenticated users
   - Use on_click=handle_logout callback for logout button

Backend anonymous session behavior:
- Backend creates HTTP-only session cookie on first anonymous request
- httpx client (cached) preserves cookies automatically
- Frontend tracks session_type="anonymous" until user authenticates
- No explicit anonymous session ID needed from frontend (backend manages)

Sidebar structure for authenticated:
```
### User Info
**Email:** user@example.com
**Role:** user
**Session:** Authenticated
[Logout] button
```

Sidebar structure for anonymous:
```
### User Info
**Session:** Anonymous
Login to save your data permanently
[Go to Login] button
```

Critical:
- Logout button must use on_click callback
- render_user_info() called from app.py BEFORE pg.run()
  </action>
  <verify>
```bash
cd frontend && python -c "
from utils.auth import handle_login, handle_register, handle_logout
from utils.session import init_session_state, render_user_info, clear_auth_state
print('All auth/session functions import correctly')
"
```
  </verify>
  <done>
- handle_logout() callback added to auth.py
- handle_logout() calls api_client.logout() and clear_auth_state()
- init_session_state() sets session_type="anonymous" when not authenticated
- render_user_info() creates sidebar with user details and logout/login buttons
  </done>
</task>

<task type="auto">
  <name>Task 2: Create home page for authenticated users</name>
  <files>frontend/pages/home.py</files>
  <action>
Create simple home page that authenticated users land on.

Implementation requirements:

1. Page title: "Home" with home icon

2. Welcome message:
   - Display "Welcome, {email}!" using session_state.user_info
   - Show brief description of what user can do

3. Quick status:
   - Show session type
   - Show role

4. Placeholder for future features:
   - "Document upload coming in Phase 8"
   - "RAG Query coming in Phase 9"

Page structure:
```python
import streamlit as st

st.title("üè† Home")

if st.session_state.get("user_info"):
    email = st.session_state.user_info.get("email", "User")
    role = st.session_state.user_info.get("role", "user")
    st.success(f"Welcome, {email}!")
    st.write(f"**Role:** {role}")
    st.write(f"**Session:** {st.session_state.get('session_type', 'unknown')}")
else:
    st.write("Welcome! You're browsing anonymously.")

st.markdown("---")
st.info("üöß Document upload coming in Phase 8")
st.info("üöß RAG Query coming in Phase 9")
```

Note: This is a simple landing page. Core functionality added in later phases.
  </action>
  <verify>
```bash
cd frontend && python -m py_compile pages/home.py && echo "Syntax OK"
```
  </verify>
  <done>
- Home page displays welcome message with user email
- Home page shows role and session type
- Placeholder info for upcoming features displayed
  </done>
</task>

<task type="auto">
  <name>Task 3: Create main app.py with dynamic navigation</name>
  <files>frontend/app.py</files>
  <action>
Create main Streamlit entry point following Pattern 1 from research.

Implementation requirements:

1. Load environment variables (python-dotenv)

2. Initialize session state:
   - Call init_session_state() at start

3. Define all pages using st.Page():
   - login_page = st.Page("pages/login.py", title="Login", icon="üîê")
   - register_page = st.Page("pages/register.py", title="Register", icon="üìù")
   - home_page = st.Page("pages/home.py", title="Home", icon="üè†")
   - debug_page = st.Page("pages/debug.py", title="Debug", icon="üîß")
   - Note: debug.py will be created in Plan 05

4. Build navigation conditionally based on is_authenticated:
   - If authenticated: show Home, Debug pages
   - If not authenticated: show Login, Register pages

5. Call st.navigation() EXACTLY ONCE:
   - pg = st.navigation(pages_dict_or_list)

6. Render sidebar user info:
   - Call render_user_info() from session.py BEFORE pg.run()

7. Run the selected page:
   - pg.run()

App structure:
```python
import streamlit as st
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Initialize session state
from utils.session import init_session_state, render_user_info
init_session_state()

# Define pages
login_page = st.Page("pages/login.py", title="Login", icon="üîê")
register_page = st.Page("pages/register.py", title="Register", icon="üìù")
home_page = st.Page("pages/home.py", title="Home", icon="üè†")
debug_page = st.Page("pages/debug.py", title="Debug", icon="üîß")

# Build navigation based on auth state
if st.session_state.get("is_authenticated"):
    pg = st.navigation({
        "Main": [home_page],
        "Tools": [debug_page],
    })
else:
    pg = st.navigation([login_page, register_page])

# Render sidebar before page
render_user_info()

# Run selected page
pg.run()
```

Critical - Avoid Pitfall #6:
- st.navigation() called EXACTLY ONCE in app.py
- NEVER call st.navigation() in page files
- Use st.switch_page() for programmatic navigation within pages

Avoid:
- Calling st.navigation multiple times
- Calling st.navigation inside conditionals that execute multiple times
- Putting st.navigation in page files
  </action>
  <verify>
```bash
cd frontend && python -m py_compile app.py && echo "Syntax OK"
grep -c "st.navigation" frontend/app.py | grep -q "1" && echo "st.navigation called exactly once"
```
  </verify>
  <done>
- app.py loads environment and initializes session state
- All pages defined with st.Page()
- Navigation built conditionally based on is_authenticated
- st.navigation called exactly once
- render_user_info() called before pg.run()
- pg.run() executes selected page
  </done>
</task>

</tasks>

<verification>
1. All imports work:
   ```bash
   cd frontend && python -c "
   from utils.auth import handle_login, handle_register, handle_logout
   from utils.session import init_session_state, render_user_info, clear_auth_state
   print('All imports OK')
   "
   ```

2. App syntax valid:
   ```bash
   cd frontend && python -m py_compile app.py && echo "app.py OK"
   cd frontend && python -m py_compile pages/home.py && echo "home.py OK"
   ```

3. st.navigation called once:
   ```bash
   grep -c "st.navigation" frontend/app.py
   # Should output: 1
   ```
</verification>

<success_criteria>
- app.py is main entry point with st.navigation
- Navigation shows Login/Register when not authenticated
- Navigation shows Home/Debug when authenticated
- Sidebar displays user info (email, role, session type)
- Logout button works via callback (no st.rerun)
- Anonymous users see "Anonymous Session" in sidebar
- st.navigation called exactly once in app.py
</success_criteria>

<output>
After completion, create `.planning/phases/07-foundation-authentication/07-04-SUMMARY.md`
</output>
