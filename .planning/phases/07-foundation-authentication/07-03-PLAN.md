---
phase: 07-foundation-authentication
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/pages/register.py
  - frontend/utils/auth.py
autonomous: true

must_haves:
  truths:
    - "User can enter email and password in registration form"
    - "User sees error message when registration fails (e.g., email exists)"
    - "User is automatically logged in after successful registration"
  artifacts:
    - path: "frontend/pages/register.py"
      provides: "Registration page with form and callback handler"
      min_lines: 40
  key_links:
    - from: "frontend/pages/register.py"
      to: "frontend/utils/auth.py"
      via: "handle_register callback import"
      pattern: "from utils.auth import handle_register"
    - from: "frontend/utils/auth.py"
      to: "frontend/utils/api_client.py"
      via: "register function call"
      pattern: "from utils.api_client import.*register"
---

<objective>
Implement registration page with callback-based authentication flow.

Purpose: Enable new users to create accounts and immediately access features without re-logging.
Output: Registration page (pages/register.py) with callback-based registration flow, updating auth.py with registration handler.
</objective>

<execution_context>
@/Users/apple/.claude/get-shit-done/workflows/execute-plan.md
@/Users/apple/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-foundation-authentication/07-RESEARCH.md
@.planning/phases/07-foundation-authentication/07-01-SUMMARY.md
@backend/app/api/auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add registration callback handler to auth.py</name>
  <files>frontend/utils/auth.py</files>
  <action>
Add handle_register() callback to existing auth.py (created in Plan 02).

Implementation requirements:

1. handle_register() callback:
   - Read email from st.session_state.register_email
   - Read password from st.session_state.register_password
   - Read password confirmation from st.session_state.register_password_confirm
   - Validate passwords match (client-side validation)
   - If no match: set st.session_state.register_error = "Passwords do not match"
   - Call register() from api_client (async wrapped in asyncio.run)
   - On success:
     - Set st.session_state.is_authenticated = True
     - Set st.session_state.access_token = result["access_token"]
     - Set st.session_state.refresh_token = result["refresh_token"]
     - Decode token and store in st.session_state.user_info
     - Set st.session_state.session_type = "authenticated"
   - On failure:
     - Set st.session_state.register_error = error message
   - NEVER call st.rerun() - let Streamlit auto-rerun after callback

2. Update imports if needed to include register from api_client

Backend contract (from auth.py):
- POST /api/v1/auth/register accepts JSON {email, password}
- Returns {access_token, refresh_token, token_type}
- Returns 409 if email already exists

Critical patterns:
- Same pattern as handle_login - callback updates session_state
- Password confirmation is client-side only (backend doesn't care)
- User immediately authenticated after registration (no separate login needed)

Note: This file was created in Plan 02. ADD handle_register without removing handle_login.
  </action>
  <verify>
```bash
cd frontend && python -c "
from utils.auth import handle_login, handle_register, decode_token_claims
print('All auth handlers import correctly')
"
```
  </verify>
  <done>
- handle_register() callback added to auth.py
- handle_register() validates password confirmation
- handle_register() calls api_client.register()
- handle_register() updates session_state on success
- handle_register() sets register_error on failure
  </done>
</task>

<task type="auto">
  <name>Task 2: Create registration page</name>
  <files>frontend/pages/register.py</files>
  <action>
Create registration page following same patterns as login page.

Implementation requirements:

1. Page title: "Register" with pencil/signup icon

2. Form elements:
   - st.text_input for email with key="register_email"
   - st.text_input for password with type="password", key="register_password"
   - st.text_input for confirm password with type="password", key="register_password_confirm"
   - st.button "Register" with on_click=handle_register

3. Error handling:
   - Check st.session_state.get("register_error")
   - Display with st.error() if present
   - Clear error after displaying

4. Success indicator:
   - If user becomes authenticated, they'll be redirected via navigation

5. Navigation hint:
   - st.markdown divider
   - st.info with "Already have an account? Go to Login page."

6. Redirect if already authenticated:
   - At top: if st.session_state.get("is_authenticated"): st.switch_page("pages/home.py")

Page structure:
```python
import streamlit as st
from utils.auth import handle_register

# Redirect if already logged in
if st.session_state.get("is_authenticated"):
    st.switch_page("pages/home.py")

st.title("üìù Register")

st.text_input("Email", key="register_email")
st.text_input("Password", type="password", key="register_password")
st.text_input("Confirm Password", type="password", key="register_password_confirm")
st.button("Register", on_click=handle_register)

# Display error if any
if st.session_state.get("register_error"):
    st.error(st.session_state.register_error)
    del st.session_state.register_error

st.markdown("---")
st.info("Already have an account? Go to Login page.")
```

Avoid:
- Using if st.button(): with inline registration logic
- Calling st.rerun() anywhere
- Sending password confirmation to backend (client-side only)
  </action>
  <verify>
```bash
cd frontend && python -m py_compile pages/register.py && echo "Syntax OK"
grep "on_click=handle_register" frontend/pages/register.py && echo "Callback pattern used"
```
  </verify>
  <done>
- Registration page displays title with icon
- Email, password, and confirm password inputs bound to session_state
- Register button uses on_click callback
- Error from session_state displayed and cleared
- Navigation hint to login shown at bottom
  </done>
</task>

</tasks>

<verification>
1. Auth module has both handlers:
   ```bash
   cd frontend && python -c "from utils.auth import handle_login, handle_register; print('OK')"
   ```

2. Register page syntax valid:
   ```bash
   cd frontend && python -m py_compile pages/register.py && echo "Syntax OK"
   ```

3. Callback pattern used:
   ```bash
   grep "on_click=handle_register" frontend/pages/register.py && echo "Callback pattern used"
   ```
</verification>

<success_criteria>
- pages/register.py exists with email/password/confirm form
- utils/auth.py exports both handle_login and handle_register
- Register button uses on_click callback (NOT if st.button inline)
- Password confirmation validated client-side before API call
- No st.rerun() calls in register.py or handle_register callback
</success_criteria>

<output>
After completion, create `.planning/phases/07-foundation-authentication/07-03-SUMMARY.md`
</output>
