---
phase: 07-foundation-authentication
plan: 05
type: execute
wave: 4
depends_on: ["07-04"]
files_modified:
  - frontend/pages/debug.py
autonomous: false

must_haves:
  truths:
    - "Debug panel shows JWT token expiry time"
    - "Debug panel shows user ID from token"
    - "All authentication flows work end-to-end"
  artifacts:
    - path: "frontend/pages/debug.py"
      provides: "Debug page with token info display"
      min_lines: 40
  key_links:
    - from: "frontend/pages/debug.py"
      to: "st.session_state"
      via: "token and user_info access"
      pattern: "session_state.*(access_token|user_info)"
---

<objective>
Create debug panel showing JWT token details and verify all authentication flows work.

Purpose: Enable troubleshooting of authentication issues and fulfill AUTH-F06 requirement.
Output: Debug page (pages/debug.py) with token expiry, user ID, and session state display. Human verification of complete auth flows.
</objective>

<execution_context>
@/Users/apple/.claude/get-shit-done/workflows/execute-plan.md
@/Users/apple/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-foundation-authentication/07-RESEARCH.md
@.planning/phases/07-foundation-authentication/07-04-SUMMARY.md
@backend/app/api/auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create debug page with token info</name>
  <files>frontend/pages/debug.py</files>
  <action>
Create debug page following research code examples.

Implementation requirements:

1. Page title: "Debug Panel" with tool icon

2. Auth guard at top:
   - If not authenticated, show warning and stop
   - Use st.warning("Login required") and st.stop()

3. JWT Token Info section:
   - Decode access_token without verification (just read claims)
   - Display in two columns:
     - Column 1: User ID, Role
     - Column 2: Token Expires (countdown), Issued At

4. Token expiry display:
   - Calculate remaining time: exp - now
   - Display as "Xm Ys" format
   - Use st.metric for visual appeal

5. Session State section:
   - Show is_authenticated, session_type, token_type
   - Use st.json for structured display

6. Expandable sections:
   - "Raw Access Token" - st.expander with st.code showing token
   - "Decoded Payload" - st.expander with st.json showing claims

Page structure from research:
```python
import streamlit as st
import jwt
from datetime import datetime, timezone

st.title("ðŸ”§ Debug Panel")

# Auth guard
if not st.session_state.get("is_authenticated"):
    st.warning("Login required to view debug info")
    st.stop()

st.subheader("JWT Token Info")

# Decode without validation
payload = jwt.decode(
    st.session_state.access_token,
    options={"verify_signature": False}
)

col1, col2 = st.columns(2)

with col1:
    st.metric("User ID", payload.get("user_id", "N/A"))
    st.metric("Role", payload.get("role", "user"))

with col2:
    exp_timestamp = payload.get("exp")
    if exp_timestamp:
        exp_dt = datetime.fromtimestamp(exp_timestamp, tz=timezone.utc)
        remaining = exp_dt - datetime.now(timezone.utc)
        if remaining.total_seconds() > 0:
            mins = int(remaining.total_seconds() // 60)
            secs = int(remaining.total_seconds() % 60)
            st.metric("Token Expires In", f"{mins}m {secs}s")
        else:
            st.metric("Token Expires In", "EXPIRED", delta="-expired")

    iat_timestamp = payload.get("iat")
    if iat_timestamp:
        iat_dt = datetime.fromtimestamp(iat_timestamp, tz=timezone.utc)
        st.metric("Issued At", iat_dt.strftime("%H:%M:%S"))

st.subheader("Session State")
st.json({
    "is_authenticated": st.session_state.get("is_authenticated"),
    "session_type": st.session_state.get("session_type", "unknown"),
    "user_email": st.session_state.get("user_info", {}).get("email", "N/A"),
})

with st.expander("Raw Access Token"):
    st.code(st.session_state.get("access_token", "No token"), language="text")

with st.expander("Decoded Payload"):
    st.json(payload)
```

Fulfills AUTH-F06: Debug panel shows token expiry time and user ID
  </action>
  <verify>
```bash
cd frontend && python -m py_compile pages/debug.py && echo "Syntax OK"
grep "user_id" frontend/pages/debug.py && echo "Shows user ID"
grep "exp" frontend/pages/debug.py && echo "Shows expiry"
```
  </verify>
  <done>
- Debug page displays JWT token info (user ID, role, expiry)
- Token expiry shown as countdown in minutes/seconds
- Session state displayed as JSON
- Raw token and decoded payload in expandable sections
- Auth guard prevents unauthenticated access
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete authentication system with:
- Login flow (email/password form, callback-based)
- Registration flow (with password confirmation)
- Logout flow (callback-based, clears session)
- Dynamic navigation (different pages based on auth state)
- Sidebar user info (email, role, session type)
- Debug panel (token expiry, user ID)
- Anonymous session support
  </what-built>
  <how-to-verify>
1. **Start the backend** (if not already running):
   ```bash
   cd backend && uvicorn app.main:app --reload
   ```

2. **Install frontend dependencies**:
   ```bash
   cd frontend && pip install -r requirements.txt
   ```

3. **Start the frontend**:
   ```bash
   cd frontend && streamlit run app.py
   ```

4. **Test Login Flow** (AUTH-F01):
   - Navigate to http://localhost:8501
   - See Login and Register pages in navigation
   - Enter email and password
   - Click Login
   - Should see Home page with sidebar showing user info
   - Expected: Sidebar shows email, role, "Authenticated" session type

5. **Test Debug Panel** (AUTH-F06):
   - Click Debug in navigation
   - Verify User ID is displayed
   - Verify Token Expires countdown is shown (should be ~15 minutes)
   - Expand "Decoded Payload" and verify claims

6. **Test Logout Flow** (AUTH-F03):
   - Click Logout button in sidebar
   - Should return to Login page
   - Navigation should show Login/Register only

7. **Test Registration Flow** (AUTH-F02):
   - Click Register in navigation
   - Enter new email, password, confirm password
   - Click Register
   - Should immediately see Home page (no separate login needed)
   - Sidebar should show new user's email

8. **Test Anonymous Session** (AUTH-F04):
   - Without logging in, observe sidebar
   - Should show "Anonymous Session"
   - (Full anonymous functionality verified in later phases)

9. **Test Sidebar User Info** (AUTH-F05):
   - When logged in, sidebar shows:
     - Email
     - Role (user/admin)
     - Session type (Authenticated)
   - When anonymous:
     - Session type (Anonymous)

Expected: All 6 AUTH-F requirements (AUTH-F01 through AUTH-F06) pass.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe which tests failed</resume-signal>
</task>

</tasks>

<verification>
1. Debug page syntax valid:
   ```bash
   cd frontend && python -m py_compile pages/debug.py && echo "OK"
   ```

2. All frontend files present:
   ```bash
   ls frontend/app.py frontend/pages/login.py frontend/pages/register.py frontend/pages/home.py frontend/pages/debug.py
   ```

3. All imports work:
   ```bash
   cd frontend && python -c "
   from utils.api_client import get_api_client, login, register, logout
   from utils.auth import handle_login, handle_register, handle_logout
   from utils.session import init_session_state, render_user_info
   print('All imports OK')
   "
   ```
</verification>

<success_criteria>
- pages/debug.py shows User ID from JWT token
- pages/debug.py shows Token Expiry countdown
- All AUTH-F requirements verified by human:
  - AUTH-F01: Login with email/password works
  - AUTH-F02: Registration creates account and auto-logs in
  - AUTH-F03: Logout returns to login screen
  - AUTH-F04: Anonymous browsing works
  - AUTH-F05: Sidebar shows user info
  - AUTH-F06: Debug panel shows token details
</success_criteria>

<output>
After completion, create `.planning/phases/07-foundation-authentication/07-05-SUMMARY.md`
</output>
