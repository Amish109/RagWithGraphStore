---
phase: 06-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/app/config.py
  - backend/app/core/logging.py
  - backend/app/core/telemetry.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "All log entries are structured JSON with request correlation IDs"
    - "Distributed traces capture request flow through the application"
    - "Trace context propagates to background tasks"
  artifacts:
    - path: "backend/app/core/logging.py"
      provides: "structlog configuration with async support"
      contains: "structlog.configure"
    - path: "backend/app/core/telemetry.py"
      provides: "OpenTelemetry tracing setup"
      contains: "FastAPIInstrumentor"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/core/logging.py"
      via: "configure_logging() call at startup"
      pattern: "configure_logging"
    - from: "backend/app/main.py"
      to: "backend/app/core/telemetry.py"
      via: "setup_telemetry() call at startup"
      pattern: "setup_telemetry"
---

<objective>
Implement structured logging with structlog and distributed tracing with OpenTelemetry for full observability.

Purpose: Enable debugging and monitoring by providing structured, searchable logs with request correlation and distributed traces that show request flow through all components.
Output: Working logging and tracing infrastructure that captures all API requests with correlation IDs and exports traces to configurable backend.
</objective>

<execution_context>
@/Users/apple/.claude/get-shit-done/workflows/execute-plan.md
@/Users/apple/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-production-hardening/06-RESEARCH.md

# Existing files to modify
@backend/app/main.py
@backend/app/config.py
@backend/requirements.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add observability dependencies and configuration</name>
  <files>backend/requirements.txt, backend/app/config.py</files>
  <action>
1. Add to requirements.txt:
   - opentelemetry-instrumentation-fastapi
   - opentelemetry-sdk
   - opentelemetry-exporter-otlp
   - opentelemetry-instrumentation-redis
   - opentelemetry-instrumentation-httpx
   - structlog

2. Add to config.py Settings class:
   - OTEL_ENABLED: bool = True (toggle for local dev)
   - OTEL_EXPORTER_ENDPOINT: str = "http://localhost:4317" (OTLP gRPC endpoint)
   - OTEL_SERVICE_NAME: str = "ragapp" (service name for traces)
   - LOG_FORMAT: str = "json" (json or console for dev)

AVOID: Do not add Jaeger-specific settings - use generic OTLP which works with Jaeger, Tempo, etc.
  </action>
  <verify>pip install -r backend/requirements.txt runs without errors; python -c "from app.config import settings; print(settings.OTEL_ENABLED)" prints True</verify>
  <done>Dependencies installed, config fields accessible</done>
</task>

<task type="auto">
  <name>Task 2: Create structured logging module with async support</name>
  <files>backend/app/core/logging.py</files>
  <action>
Create backend/app/core/logging.py with:

1. Request ID context variable using contextvars.ContextVar
2. configure_logging() function that:
   - Configures structlog with merge_contextvars processor
   - Adds log level, timestamp (ISO format), and request_id
   - Uses JSONRenderer for production (settings.LOG_FORMAT == "json")
   - Uses ConsoleRenderer for development (settings.LOG_FORMAT == "console")
   - Sets filtering to settings.LOG_LEVEL
   - Enables cache_logger_on_first_use=True for performance

3. get_logger() helper that returns structlog.get_logger()

4. RequestLoggingMiddleware class that:
   - Generates UUID request_id on each request
   - Stores request_id in context variable
   - Logs request start (method, path, user_id if available)
   - Logs request end (status_code, duration_ms)
   - Uses structlog's async methods (ainfo, aerror) to avoid blocking

CRITICAL: Use await logger.ainfo() not logger.info() to prevent blocking the event loop.
AVOID: Do not log request bodies (may contain sensitive data).
  </action>
  <verify>python -c "from app.core.logging import configure_logging, get_logger; configure_logging(); logger = get_logger(); import asyncio; asyncio.run(logger.ainfo('test'))" outputs JSON log line</verify>
  <done>Structured logging configured with request correlation, async methods work without blocking</done>
</task>

<task type="auto">
  <name>Task 3: Create OpenTelemetry tracing module and integrate into main.py</name>
  <files>backend/app/core/telemetry.py, backend/app/main.py</files>
  <action>
1. Create backend/app/core/telemetry.py with:

   setup_telemetry(app: FastAPI) function that:
   - Checks settings.OTEL_ENABLED (skip if False for local dev)
   - Creates TracerProvider with Resource (service.name from settings)
   - Adds BatchSpanProcessor with OTLPSpanExporter to settings.OTEL_EXPORTER_ENDPOINT
   - Calls trace.set_tracer_provider()
   - Calls FastAPIInstrumentor.instrument_app(app)
   - Instruments redis with opentelemetry.instrumentation.redis
   - Instruments httpx with opentelemetry.instrumentation.httpx
   - Returns early with log message if OTEL_ENABLED=False

   get_tracer() helper function that returns trace.get_tracer("ragapp")

2. Modify backend/app/main.py:
   - Import configure_logging from app.core.logging
   - Import setup_telemetry from app.core.telemetry
   - Call configure_logging() at very start of lifespan (before any other prints)
   - Call setup_telemetry(app) after app creation but before routers
   - Replace print() calls with structlog logger (get_logger())
   - Add RequestLoggingMiddleware to app

CRITICAL: setup_telemetry must be called BEFORE routers are included to instrument all endpoints.
AVOID: Do not use synchronous trace exporters - use BatchSpanProcessor for async export.
  </action>
  <verify>
1. Run: OTEL_ENABLED=false uvicorn app.main:app --host 0.0.0.0 --port 8000 &
2. curl http://localhost:8000/health
3. Check logs show JSON with request_id
4. Kill uvicorn
  </verify>
  <done>OpenTelemetry tracing configured, all startup logs use structlog, request logging middleware active</done>
</task>

</tasks>

<verification>
1. Start app with OTEL_ENABLED=false (no trace backend needed):
   - All logs are JSON formatted
   - Each request has unique request_id
   - Request duration logged on completion

2. Verify async logging doesn't block:
   - No warnings about sync calls in async context
   - Response times unaffected by logging

3. Code inspection:
   - No print() statements remain in main.py
   - All log calls use await logger.ainfo/aerror pattern
</verification>

<success_criteria>
- structlog configured with JSON output and request correlation
- OpenTelemetry instrumentation ready (enabled/disabled via config)
- All main.py startup/shutdown messages use structured logging
- RequestLoggingMiddleware logs every request with method, path, status, duration
- No blocking log calls in async code paths
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-hardening/06-01-SUMMARY.md`
</output>
