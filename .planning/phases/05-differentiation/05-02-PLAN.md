---
phase: 05-differentiation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/services/simplification_service.py
  - backend/app/api/queries.py
  - backend/app/models/schemas.py
autonomous: true

must_haves:
  truths:
    - "User can request simplified explanations of complex document content"
    - "Multiple simplification levels available (eli5, general, professional)"
    - "Simplified text is appropriate for the target reading level"
    - "Context from document improves simplification accuracy"
  artifacts:
    - path: "backend/app/services/simplification_service.py"
      provides: "Text simplification with two-stage prompting"
      exports: ["simplify_text", "simplify_document_section", "SIMPLIFICATION_LEVELS"]
    - path: "backend/app/api/queries.py"
      provides: "POST /simplify endpoint"
      contains: "@router.post(\"/simplify\")"
    - path: "backend/app/models/schemas.py"
      provides: "SimplifyRequest and SimplifyResponse schemas"
      contains: "class SimplifyRequest"
  key_links:
    - from: "backend/app/api/queries.py"
      to: "backend/app/services/simplification_service.py"
      via: "import simplify_document_section"
      pattern: "from app.services.simplification_service import"
    - from: "backend/app/services/simplification_service.py"
      to: "backend/app/services/retrieval_service.py"
      via: "context retrieval for better simplification"
      pattern: "from app.services.retrieval_service import"
---

<objective>
Implement text simplification service that explains complex content at configurable reading levels.

Purpose: Enable users to request simplified explanations of complex document content (QRY-07). This helps users understand technical or complex content without specialized knowledge.

Output: Simplification service with two-stage prompting, API endpoint, and request/response schemas.
</objective>

<execution_context>
@/Users/apple/.claude/get-shit-done/workflows/execute-plan.md
@/Users/apple/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-differentiation/05-RESEARCH.md

# Existing files to extend
@backend/app/services/retrieval_service.py
@backend/app/api/queries.py
@backend/app/models/schemas.py
@backend/app/services/generation_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Simplification Service</name>
  <files>backend/app/services/simplification_service.py</files>
  <action>
Create new simplification service implementing text simplification with reading level control:

1. Define SIMPLIFICATION_LEVELS dictionary with configuration for each level:
```python
SIMPLIFICATION_LEVELS = {
    "eli5": {
        "description": "Explain like I'm 5 years old",
        "prompt": "Explain this in very simple terms that a child could understand. Use everyday analogies and avoid technical words.",
        "reading_level": "elementary"
    },
    "general": {
        "description": "General audience explanation",
        "prompt": "Explain this for someone with no background in this field. Use simple language and define any technical terms.",
        "reading_level": "8th grade"
    },
    "professional": {
        "description": "Professional but accessible",
        "prompt": "Explain this for a professional in a different field. Be clear but don't oversimplify technical concepts.",
        "reading_level": "college"
    }
}
```

2. Implement `simplify_text(text: str, level: str, context: Optional[str]) -> dict`:
   - Two-stage prompting approach (as per research):
   - Stage 1: Generate initial simplified explanation using level-specific prompt
   - Stage 2: Verify and adjust to target reading level
   - Include context in prompt if provided (improves accuracy)
   - Return dict with: original_text (truncated to 500 chars), simplified_text, level, level_description

3. Implement `simplify_document_section(document_id, user_id, section_text, level) -> dict`:
   - Import retrieve_relevant_context from retrieval_service
   - Use first 500 chars of section_text as query to get surrounding context
   - Call simplify_text with retrieved context
   - Return simplification result

Use ChatOpenAI with temperature=0.4 for slight creativity in explanations.
Use langchain_core.prompts.ChatPromptTemplate.
Follow existing patterns from generation_service.py.
  </action>
  <verify>
```bash
cd /Users/apple/Desktop/RAGWithGraphStore/backend
python -c "from app.services.simplification_service import simplify_text, simplify_document_section, SIMPLIFICATION_LEVELS; print('Imports OK')"
```
  </verify>
  <done>Simplification service exists with simplify_text, simplify_document_section, and SIMPLIFICATION_LEVELS exported. Two-stage prompting implemented.</done>
</task>

<task type="auto">
  <name>Task 2: Add Simplification Schemas and API Endpoint</name>
  <files>backend/app/models/schemas.py, backend/app/api/queries.py</files>
  <action>
1. In schemas.py, add SimplifyRequest and SimplifyResponse models:
```python
class SimplifyRequest(BaseModel):
    """Schema for text simplification request."""
    text: str
    document_id: Optional[str] = None  # For context retrieval
    level: str = "general"  # eli5, general, professional

class SimplifyResponse(BaseModel):
    """Schema for text simplification response."""
    original_text: str  # Truncated to 500 chars
    simplified_text: str
    level: str
    level_description: str
```

2. In queries.py, add POST endpoint for text simplification:
```python
@router.post("/simplify", response_model=SimplifyResponse)
async def simplify_content(
    request: SimplifyRequest,
    current_user: dict = Depends(get_current_user),
):
```

Endpoint implementation:
- Import simplify_document_section and simplify_text from simplification_service
- If document_id provided: use simplify_document_section for context-aware simplification
- If no document_id: use simplify_text directly (text-only simplification)
- Validate level is one of: eli5, general, professional
- Return 400 HTTPException if invalid level
- Return SimplifyResponse on success

Import HTTPException and status from fastapi for error handling.
  </action>
  <verify>
```bash
cd /Users/apple/Desktop/RAGWithGraphStore/backend
python -c "from app.api.queries import router; from app.models.schemas import SimplifyRequest, SimplifyResponse; print('Imports OK')"
```
  </verify>
  <done>SimplifyRequest and SimplifyResponse schemas added to schemas.py. POST /simplify endpoint added to queries.py with level validation.</done>
</task>

<task type="auto">
  <name>Task 3: Verification and Documentation</name>
  <files>None (verification only)</files>
  <action>
Verify the complete simplification flow works:

1. Verify all imports work correctly:
```bash
cd /Users/apple/Desktop/RAGWithGraphStore/backend
python -c "
from app.services.simplification_service import simplify_text, simplify_document_section, SIMPLIFICATION_LEVELS
from app.api.queries import router
from app.models.schemas import SimplifyRequest, SimplifyResponse
print('All imports successful')
"
```

2. Verify SIMPLIFICATION_LEVELS has required levels:
```bash
python -c "
from app.services.simplification_service import SIMPLIFICATION_LEVELS
required = ['eli5', 'general', 'professional']
for level in required:
    assert level in SIMPLIFICATION_LEVELS, f'Missing level: {level}'
print('All 3 simplification levels defined')
"
```

3. Verify schemas have required fields:
```bash
python -c "
from app.models.schemas import SimplifyRequest, SimplifyResponse
print('SimplifyRequest fields:', list(SimplifyRequest.model_fields.keys()))
print('SimplifyResponse fields:', list(SimplifyResponse.model_fields.keys()))
"
```

4. Verify no syntax errors:
```bash
python -m py_compile app/services/simplification_service.py
python -m py_compile app/api/queries.py
python -m py_compile app/models/schemas.py
echo "Syntax validation passed"
```
  </action>
  <verify>
```bash
cd /Users/apple/Desktop/RAGWithGraphStore/backend
python -c "from app.services.simplification_service import SIMPLIFICATION_LEVELS; assert len(SIMPLIFICATION_LEVELS) == 3; print('OK: 3 simplification levels')"
```
  </verify>
  <done>Simplification service has 3 levels (eli5, general, professional), two-stage prompting, and all files pass syntax validation.</done>
</task>

</tasks>

<verification>
```bash
cd /Users/apple/Desktop/RAGWithGraphStore/backend

# Verify all imports work
python -c "
from app.services.simplification_service import simplify_text, simplify_document_section, SIMPLIFICATION_LEVELS
from app.api.queries import router
from app.models.schemas import SimplifyRequest, SimplifyResponse
print('All imports successful')
print('Simplification levels:', list(SIMPLIFICATION_LEVELS.keys()))
"

# Verify no syntax errors in modified files
python -m py_compile app/services/simplification_service.py
python -m py_compile app/api/queries.py
python -m py_compile app/models/schemas.py
echo "Syntax validation passed"
```
</verification>

<success_criteria>
1. simplification_service.py exists with simplify_text, simplify_document_section, SIMPLIFICATION_LEVELS
2. SIMPLIFICATION_LEVELS contains 3 levels: eli5, general, professional
3. Two-stage prompting implemented (simplify then verify reading level)
4. SimplifyRequest and SimplifyResponse schemas added to schemas.py
5. POST /simplify endpoint added to queries.py
6. Level validation returns 400 for invalid levels
7. All files pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/05-differentiation/05-02-SUMMARY.md`
</output>
